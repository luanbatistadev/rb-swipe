require 'dotenv'
Dotenv.load(File.join(__dir__, '.env'))

API_KEY_PATH = File.expand_path('AuthKey_SK4K9F2672.p8', __dir__)

def get_release_notes
  commits = `git log --oneline -2`.strip.split("\n")
  notes = "O que testar:\n"
  commits.each do |commit|
    message = commit.sub(/^[a-f0-9]+ /, '')
    notes += "- #{message}\n"
  end
  notes
end

default_platform(:ios)

platform :ios do
  desc "Build e upload para TestFlight"
  lane :beta do
    Dir.chdir("../..") do
      sh("flutter build ios --release --no-codesign")
    end

    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: API_KEY_PATH,
      duration: 1200,
      in_house: false
    )

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios",
      output_name: "rb_swipe.ipa"
    )

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      changelog: get_release_notes
    )
  end

  desc "Apenas upload (sem build)"
  lane :upload do
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: API_KEY_PATH,
      duration: 1200,
      in_house: false
    )

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      ipa: "../build/ios/rb_swipe.ipa",
      changelog: get_release_notes
    )
  end

  desc "Apenas build (sem upload)"
  lane :build do
    Dir.chdir("../..") do
      sh("flutter build ios --release --no-codesign")
    end

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios",
      output_name: "rb_swipe.ipa"
    )
  end
end
